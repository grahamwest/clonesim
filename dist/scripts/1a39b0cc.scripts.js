"use strict";var cellsim=angular.module("CellSimModule",[]).config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode(!1).hashPrefix("!"),a.when("/view/:id",{templateUrl:"/views/viewSim.html",controller:"ViewSimCtrl"}).otherwise({redirectTo:"/view/1"})}]);cellsim.controller("MainCtrl",function(){}),cellsim.service("SimService",function(){this.read=function(){return this.runSim()},this.runSim=function(){var a=new SimulationRun(100,5e3,new RandomBooleanSeedStrategy(.5),new NeighbourSwapIterationStrategy(.95,5e-5));return a.seed(),a.iterateAll(),a}}),cellsim.controller("ViewSimCtrl",["$scope","$routeParams","SimService",function(a){a.numCells=120,a.numGenerations=500,a.seedStrategies=[{label:"Random",value:"RandomBooleanSeedStrategy"}],a.seedStrategy=a.seedStrategies[0],a.seedStrategyParam=.5,a.clumpSize=1,a.iterationStrategies=[{label:"Neighbour Swap",value:"NeighbourSwapIterationStrategy"}],a.iterationStrategy=a.iterationStrategies[0],a.iterationStrategyParam={replacedByNeighbourRate:.1,decayRate:0},a.colorsTrue="#007BA7",a.colorsFalse="#FFFFFF",a.colorsVoid="#CCCCCC",a.runNewSim=function(){var b=1-a.iterationStrategyParam.replacedByNeighbourRate,c=new SimulationRun(a.numCells,a.numGenerations+1,new RandomBooleanSeedStrategy(a.seedStrategyParam,5),new NeighbourSwapIterationStrategy(b,a.iterationStrategyParam.decayRate));c.seed(a.clumpSize),c.iterateAll(),a.simResult=c,a.simCount++},a.saveAsCsv=function(){var b=a.simResult,c=new Blob([simToCsv(b)],{type:"text/csv;charset=utf-8"});saveAs(c,"simulation_data.csv")};var b=function(a){var b;b=a.split(",")[0].indexOf("base64")>=0?atob(a.split(",")[1]):unescape(a.split(",")[1]);for(var c=(a.split(",")[0].split(":")[1].split(";")[0],new ArrayBuffer(b.length)),d=new Uint8Array(c),e=0;e<b.length;e++)d[e]=b.charCodeAt(e);return new Blob([c])};a.saveAsPng=function(){var a=b(document.getElementsByTagName("canvas")[0].toDataURL("image/png"));saveAs(a,"simulation.png")},a.simCount=0,a.drawVoidsOptions=[{label:"Inline",value:"inline"},{label:"Grouped",value:"bottom"},{label:"Hidden",value:"hidden"}],a.drawVoids=a.drawVoidsOptions[1]}]);var saveAs=saveAs||navigator.msSaveBlob&&navigator.msSaveBlob.bind(navigator)||function(a){var b=a.document,c=function(){return a.URL||a.webkitURL||a},d=a.URL||a.webkitURL||a,e=b.createElementNS("http://www.w3.org/1999/xhtml","a"),f="download"in e,g=function(c){var d=b.createEvent("MouseEvents");return d.initMouseEvent("click",!0,!1,a,0,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(d)},h=a.webkitRequestFileSystem,i=a.requestFileSystem||h||a.mozRequestFileSystem,j=function(b){(a.setImmediate||a.setTimeout)(function(){throw b},0)},k="application/octet-stream",l=0,m=[],n=function(){for(var a=m.length;a--;){var b=m[a];"string"==typeof b?d.revokeObjectURL(b):b.remove()}m.length=0},o=function(a,b,c){b=[].concat(b);for(var d=b.length;d--;){var e=a["on"+b[d]];if("function"==typeof e)try{e.call(a,c||a)}catch(f){j(f)}}},p=function(b,d){var j,n,p,q=this,r=b.type,s=!1,t=function(){var a=c().createObjectURL(b);return m.push(a),a},u=function(){o(q,"writestart progress write writeend".split(" "))},v=function(){(s||!j)&&(j=t(b)),n&&(n.location.href=j),q.readyState=q.DONE,u()},w=function(a){return function(){return q.readyState!==q.DONE?a.apply(this,arguments):void 0}},x={create:!0,exclusive:!1};return q.readyState=q.INIT,d||(d="download"),f&&(j=t(b),e.href=j,e.download=d,g(e))?(q.readyState=q.DONE,void u()):(a.chrome&&r&&r!==k&&(p=b.slice||b.webkitSlice,b=p.call(b,0,b.size,k),s=!0),h&&"download"!==d&&(d+=".download"),n=r===k||h?a:a.open(),i?(l+=b.size,void i(a.TEMPORARY,l,w(function(a){a.root.getDirectory("saved",x,w(function(a){var c=function(){a.getFile(d,x,w(function(a){a.createWriter(w(function(c){c.onwriteend=function(b){n.location.href=a.toURL(),m.push(a),q.readyState=q.DONE,o(q,"writeend",b)},c.onerror=function(){var a=c.error;a.code!==a.ABORT_ERR&&v()},"writestart progress write abort".split(" ").forEach(function(a){c["on"+a]=q["on"+a]}),c.write(b),q.abort=function(){c.abort(),q.readyState=q.DONE},q.readyState=q.WRITING}),v)}),v)};a.getFile(d,{create:!1},w(function(a){a.remove(),c()}),w(function(a){a.code===a.NOT_FOUND_ERR?c():v()}))}),v)}),v)):void v())},q=p.prototype,r=function(a,b){return new p(a,b)};return q.abort=function(){var a=this;a.readyState=a.DONE,o(a,"abort")},q.readyState=q.INIT=0,q.WRITING=1,q.DONE=2,q.error=q.onwritestart=q.onprogress=q.onwrite=q.onabort=q.onerror=q.onwriteend=null,a.addEventListener("unload",n,!1),r}(self),roundNumber=function(a,b){var c=Math.round(a*Math.pow(10,b))/Math.pow(10,b);return c};window.simToCsv=function(a){var b=[],c=function(a,b,c,d){var e=[];e.push(c);for(var f=0;f<a.size();f++)e.push(d(a.data[f],b,f));return e.join(",")};b.push(c(a,0,"Cell Generation #",function(a,b,c){return c}));for(var d=0;d<a.getFirst().size();d++)b.push(c(a,d,d+1,function(a,b){return a.data[b]===!0?"1":a.data[b]===!1?"0":"-"}));var e=function(d,e,f){b.push(c(a,f,d,e))};return e("Number Positive Cells",function(a){return a.countCellsWithValue(!0)}),e("Number Negative Cells",function(a){return a.countCellsWithValue(!1)}),e("Total Positive + Negative Cell Number",function(a){return a.countCellsWithValue(!0)+a.countCellsWithValue(!1)}),e("Number Positive Stripes",function(a){return a.countRunsWithValue(!0)}),e("Number Negative Stripes",function(a){return a.countRunsWithValue(!1)}),e("Uncorrected Stripe Count (positive + negative stripes)",function(a){return a.countRunsWithValue(!1)+a.countRunsWithValue(!0)}),e("Proportion positive cells = p",function(a){var b=a.countCellsWithValue(!0),c=a.countCellsWithValue(!1),d=b/(b+c);return a.proportionTrue=d,roundNumber(d,2)}),e("Mean # positive cells per stripe width",function(a){return a.countCellsWithValue(!0)/a.countRunsWithValue(!0)}),e("Correction factor 1/(1-p)",function(a){return 1/(1-a.proportionTrue)}),e("Corrected mean # positive cells per stripe width",function(a){var b=a.countCellsWithValue(!0)/a.countRunsWithValue(!0),c=1/(1-a.proportionTrue);return b/c}),e("Corrected positive stripe number",function(a){var b=1/(1-a.proportionTrue);return b*a.countRunsWithValue(!0)}),e("Corrected total (pos + neg) stripe number",function(a){var b=1/(1-a.proportionTrue),c=a.countCellsWithValue(!0),d=a.countRunsWithValue(!0),e=a.countCellsWithValue(!1),f=c/d/b,g=(e+c)/f;return g}),b.join("\n")};